@inherits LayoutComponentBase
@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService
@inject NavigationManager NavigationManager

<PageTitle>Video Diary</PageTitle>

<div class="page">
    <NavMenu />
    <main>
        <article class="content px-4">
            @if (!_statusLoaded)
            {
                <div class="login-required">
                    <p>Loading...</p>
                </div>
            }
            else if (_status.AuthenticationEnabled && !_status.IsAuthenticated && !IsLoginPage())
            {
                <section class="login-required">
                    <h1>Authentication Required</h1>
                    <p>You need to sign in to use this application.</p>
                    <p><a href="/login" class="nav-link" style="font-size: 1.2rem; font-weight: 600;">Sign In</a></p>
                </section>
            }
            else
            {
                @Body
            }
        </article>
    </main>
</div>

@code {
    private UserStatusDto _status = new(false, null, false);
    private bool _statusLoaded;

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();
        _statusLoaded = true;
    }

    private bool IsLoginPage()
    {
        var currentPath = new Uri(NavigationManager.Uri).AbsolutePath;
        return currentPath.Equals("/login", StringComparison.OrdinalIgnoreCase);
    }
}
