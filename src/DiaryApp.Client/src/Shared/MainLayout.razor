@inherits LayoutComponentBase
@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService
@inject NavigationManager NavigationManager

<PageTitle>Rec-One</PageTitle>

<div class="page">
    <NavMenu />
    <main>
        <article class="content px-4">
            @if (!_statusLoaded)
            {
                <div class="login-required">
                    <p>Loading...</p>
                </div>
            }
            else if (_status.AuthenticationEnabled && !_status.IsAuthenticated && !IsLoginPage())
            {
                <LoginRequired />
            }
            else
            {
                @Body
            }
        </article>
    </main>
</div>

<Toast />

@code {
    private UserStatusDto _status = new(false, null, false, null, null);
    private bool _statusLoaded;
    private bool _autoLoginTriggered;

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();

        if (TryAutoLogin(_status))
        {
            return;
        }

        _statusLoaded = true;
    }

    private bool TryAutoLogin(UserStatusDto status)
    {
        if (_autoLoginTriggered)
        {
            return false;
        }

        if (!status.AuthenticationEnabled || status.IsAuthenticated)
        {
            return false;
        }

        if (string.IsNullOrWhiteSpace(status.LastProvider))
        {
            return false;
        }

        if (IsLoginPage())
        {
            return false;
        }

        _autoLoginTriggered = true;
        var target = $"/login/{status.LastProvider.ToLowerInvariant()}";
        NavigationManager.NavigateTo(target, forceLoad: true);
        return true;
    }

    private bool IsLoginPage()
    {
        var currentPath = new Uri(NavigationManager.Uri).AbsolutePath;
        return currentPath.Equals("/login", StringComparison.OrdinalIgnoreCase);
    }
}
