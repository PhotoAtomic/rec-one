@inherits LayoutComponentBase
@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService

<PageTitle>Video Diary</PageTitle>

<div class="page">
    <NavMenu />
    <main>
        <article class="content px-4">
            @if (!_statusLoaded)
            {
                <div class="login-required">
                    <p>Loading...</p>
                </div>
            }
            else if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
            {
                <section class="login-required">
                    <h1>Authentication Required</h1>
                    <p>We tried to refresh your sign-in silently, but it appears to have expired. Please <a href="/login">log in</a> to continue.</p>
                </section>
            }
            else
            {
                @Body
            }
        </article>
    </main>
</div>

@code {
    private UserStatusDto _status = new(false, null, false);
    private bool _statusLoaded;

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();
        if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
        {
            _status = await AuthStatusService.RefreshAsync();
        }
        _statusLoaded = true;
    }
}
