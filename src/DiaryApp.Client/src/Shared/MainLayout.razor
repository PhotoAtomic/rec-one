@inherits LayoutComponentBase
@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService
@inject NavigationManager NavigationManager

<PageTitle>Video Diary</PageTitle>

<div class="page">
    <NavMenu />
    <main>
        <article class="content px-4">
            @if (!_statusLoaded)
            {
                <div class="login-required">
                    <p>Loading...</p>
                </div>
            }
            else if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
            {
                <section class="login-required">
                    <h1>Authentication Required</h1>
                    <p>@(_silentRefreshFailed
                        ? "We tried to refresh your sign-in silently, but it appears to have expired. Please log in to continue."
                        : "Hold on, we're refreshing your sign-in...")</p>
                    @if (_silentRefreshFailed)
                    {
                        <p><a href="/login">Click here</a> to sign in.</p>
                    }
                </section>
            }
            else
            {
                @Body
            }
        </article>
    </main>
</div>

@code {
    private UserStatusDto _status = new(false, null, false);
    private bool _statusLoaded;
    private bool _attemptedSilentLogin;
    private bool _silentRefreshFailed;

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();
        if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
        {
            _status = await AuthStatusService.RefreshAsync();
            if (!_status.IsAuthenticated && !_attemptedSilentLogin)
            {
                _attemptedSilentLogin = true;
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }

            _silentRefreshFailed = !_status.IsAuthenticated;
        }
        _statusLoaded = true;
    }
}
