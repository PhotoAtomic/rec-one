@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.Reflection

<nav class="nav-menu">
    @if (_statusLoaded && (!_status.AuthenticationEnabled || _status.IsAuthenticated))
    {
        <button class="nav-hamburger" @onclick="ToggleMobileMenu" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    }
    
    @if (!_statusLoaded)
    {
        <div class="nav-links"></div>
    }
    else if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
    {
        <div class="nav-menu-right">
            <a href="/login" class="nav-link">Login</a>
        </div>
    }
    else
    {
        <div class="nav-mobile-dropdown @(_mobileMenuOpen ? "mobile-open" : "")">
            <div class="nav-links @(_mobileMenuOpen ? "mobile-open" : "")">
                <NavLink href="/" class="nav-link" Match="NavLinkMatch.All" @onclick="CloseMobileMenu">Record</NavLink>
                <NavLink href="/entries" class="nav-link" @onclick="CloseMobileMenu">Entries</NavLink>
                <NavLink href="/outgoing" class="nav-link" @onclick="CloseMobileMenu">Outgoing</NavLink>
                <NavLink href="/settings" class="nav-link" @onclick="CloseMobileMenu">Settings</NavLink>
                @if (_pwaInstallAvailable)
                {
                    <a href="#" class="nav-link" @onclick="TriggerInstall">Install</a>
                }
            </div>
            <div class="nav-menu-right @(_mobileMenuOpen ? "mobile-open" : "")">
                @if (_status.IsAuthenticated)
                {
                    <div class="nav-greeting" title="@(_status.Name ?? "there")">Hi, @(_status.Name ?? "there")</div>
                    <a href="/logout" class="nav-link" @onclick="CloseMobileMenu">Logout</a>
                }
                else if (_statusLoaded && _status.AuthenticationEnabled)
                {
                    <a href="/login" class="nav-link" @onclick="CloseMobileMenu">Login</a>
                }
            </div>
        </div>
    }
    <div class="nav-version-area">
        @if (_statusLoaded && _status.AuthenticationEnabled)
        {
            <button class="nav-disclaimer-button" @onclick="ShowDisclaimer" title="Show disclaimer">
                <svg class="disclaimer-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 20h20L12 2z" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M11 10h2v5h-2v-5zm0 6h2v2h-2v-2z" fill="currentColor"/>
                </svg>
            </button>
        }
        <span class="nav-version">v@_version</span>
    </div>
</nav>

<DisclaimerModal @ref="_disclaimerModal" AutoShow="false" AllowDismiss="true" />

@code {
    private UserStatusDto _status = new(false, null, false, null);
    private bool _statusLoaded;
    private DisclaimerModal? _disclaimerModal;
    private string _version = "";
    private bool _mobileMenuOpen = false;

    // PWA install handling
    private bool _pwaInstallAvailable = false;
    private Microsoft.JSInterop.IJSObjectReference? _pwaModule;

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();
        _statusLoaded = true;
        var clientAssembly = typeof(App).Assembly;
        var version = clientAssembly.GetName().Version;
        var versionString = version != null
            ? $"{version.Major}.{version.Minor}.{version.Build}.{version.Revision}"
            : "1.0.0.0";
        _version = versionString;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _pwaModule = await JS.InvokeAsync<Microsoft.JSInterop.IJSObjectReference>("import", new object[] { "./js/pwaInstall.js" });
            _pwaInstallAvailable = await _pwaModule.InvokeAsync<bool>("isInstallAvailable", Array.Empty<object>());
            StateHasChanged();
        }
    }

    private async Task TriggerInstall()
    {
        if (_pwaModule is null)
        {
            return;
        }
        var installed = await _pwaModule.InvokeAsync<bool>("triggerInstall", Array.Empty<object>());
        if (installed)
        {
            _pwaInstallAvailable = false; // hide link after install
            StateHasChanged();
        }
    }

    private async Task ShowDisclaimer()
    {
        if (_disclaimerModal != null)
        {
            await _disclaimerModal.Show();
        }
    }

    private void ToggleMobileMenu()
    {
        _mobileMenuOpen = !_mobileMenuOpen;
    }

    private void CloseMobileMenu()
    {
        _mobileMenuOpen = false;
    }
}
