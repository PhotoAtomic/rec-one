@using DiaryApp.Shared.Abstractions
@inject DiaryApp.Client.Services.AuthenticationStatusService AuthStatusService
@using System.Reflection

<nav class="nav-menu">
    @if (!_statusLoaded)
    {
        <div class="nav-links"></div>
    }
    else if (_status.AuthenticationEnabled && !_status.IsAuthenticated)
    {
        <div class="nav-menu-right">
            <a href="/login" class="nav-link">Login</a>
        </div>
    }
    else
    {
        <div class="nav-links">
            <NavLink href="/" class="nav-link" Match="NavLinkMatch.All">Record</NavLink>
            <NavLink href="/entries" class="nav-link">Entries</NavLink>
            <NavLink href="/outgoing" class="nav-link">Outgoing</NavLink>
            <NavLink href="/settings" class="nav-link">Settings</NavLink>
        </div>
        <div class="nav-menu-right">
            @if (_status.AuthenticationEnabled)
            {
                <button class="nav-link nav-disclaimer-button" @onclick="ShowDisclaimer" title="Show disclaimer">
                    <svg class="disclaimer-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 20h20L12 2z" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M11 10h2v5h-2v-5zm0 6h2v2h-2v-2z" fill="currentColor"/>
                    </svg>
                </button>
            }
            @if (_status.IsAuthenticated)
            {
                <div class="nav-greeting">Hi, @(_status.Name ?? "there")</div>
                <a href="/logout" class="nav-link">Logout</a>
            }
            else if (_statusLoaded && _status.AuthenticationEnabled)
            {
                <a href="/login" class="nav-link">Login</a>
            }
        </div>
    }
    <span class="nav-version">v@_version</span>
</nav>

<DisclaimerModal @ref="_disclaimerModal" AutoShow="false" AllowDismiss="true" />

@code {
    private UserStatusDto _status = new(false, null, false);
    private bool _statusLoaded;
    private DisclaimerModal? _disclaimerModal;
    private string _version = "";

    protected override async Task OnInitializedAsync()
    {
        _status = await AuthStatusService.GetStatusAsync();
        _statusLoaded = true;
        var clientAssembly = typeof(App).Assembly;
        var version = clientAssembly.GetName().Version;
        var versionString = version != null
            ? $"{version.Major}.{version.Minor}.{version.Build}.{version.Revision}"
            : "1.0.0.0";
        _version = versionString;
    }

    private async Task ShowDisclaimer()
    {
        if (_disclaimerModal != null)
        {
            await _disclaimerModal.Show();
        }
    }
}
