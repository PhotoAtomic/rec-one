@page "/login"
@using DiaryApp.Shared.Abstractions
@inject HttpClient Http

<PageTitle>Login - Video Diary</PageTitle>

<div class="login-page">
    <div class="login-container">
        <h1 class="login-title">Welcome to Video Diary</h1>
        <p class="login-subtitle">Choose your login provider</p>
        
        @if (_isLoading)
        {
            <p class="login-loading">Loading...</p>
        }
        else if (_providers.Count == 0)
        {
            <p class="login-error">No authentication providers configured.</p>
        }
        else
        {
            <div class="login-providers">
                @foreach (var provider in _providers)
                {
                    <a href="@provider.LoginPath" 
                       class="provider-button @provider.Name.ToLowerInvariant()">
                        @if (!string.IsNullOrWhiteSpace(provider.LogoPath))
                        {
                            <img src="@provider.LogoPath" alt="@provider.DisplayName logo" class="provider-logo" />
                        }
                        <span>Sign in with @provider.DisplayName</span>
                    </a>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(_disclaimerText))
            {
                <div class="login-disclaimer">
                    <h3>Important Notice</h3>
                    <div class="login-disclaimer__content">
                        @foreach (var line in _disclaimerText.Split('\n'))
                        {
                            <p>@line</p>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private bool _isLoading = true;
    private List<AuthenticationProviderInfo> _providers = new();
    private string? _disclaimerText;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load providers
            var providersResponse = await Http.GetFromJsonAsync<AvailableProvidersDto>("/authentication/providers");
            if (providersResponse?.Providers != null)
            {
                _providers = providersResponse.Providers.ToList();
            }

            // Load disclaimer text
            try
            {
                var disclaimerResponse = await Http.GetFromJsonAsync<DisclaimerOptions>("/api/settings/disclaimer");
                _disclaimerText = disclaimerResponse?.Text;
            }
            catch
            {
                _disclaimerText = null;
            }
        }
        catch
        {
            _providers = new List<AuthenticationProviderInfo>();
        }
        finally
        {
            _isLoading = false;
        }
    }
}
