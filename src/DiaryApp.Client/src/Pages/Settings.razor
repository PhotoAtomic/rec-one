@page "/settings"
@implements IAsyncDisposable
@inject IMediaSettingsClient MediaSettingsClient
@inject IDevicePreferencesService DevicePreferencesService
@inject IServerSettingsClient ServerSettingsClient
@inject IJSRuntime JsRuntime
@using System
@using System.Collections.Generic
@using System.Linq
@using DiaryApp.Shared.Abstractions
@using Microsoft.JSInterop

<h1>Recording Settings</h1>

@if (_isLoading)
{
    <p>Loading your device preferences...</p>
}
else
{
    <EditForm Model="_formModel" OnValidSubmit="SavePreferences">
        <div class="settings-section">
            <label for="cameraSelect">Preferred webcam</label>
            <select id="cameraSelect" @bind="_formModel.CameraDeviceId">
                <option value="">System default</option>
                @foreach (var camera in _cameras)
                {
                    <option value="@camera.DeviceId">@camera.Label</option>
                }
            </select>
            <small>Stored on this device only (browser cookie).</small>
        </div>

        <div class="settings-section">
            <label for="microphoneSelect">Preferred microphone</label>
            <select id="microphoneSelect" @bind="_formModel.MicrophoneDeviceId">
                <option value="">System default</option>
                @foreach (var microphone in _microphones)
                {
                    <option value="@microphone.DeviceId">@microphone.Label</option>
                }
            </select>
            <small>Stored on this device only (browser cookie).</small>
        </div>

        <div class="settings-section">
            <label for="languageSelect">Transcript language</label>
            <select id="languageSelect" @bind="_formModel.TranscriptLanguage">
                @foreach (var language in LanguageOptions)
                {
                    <option value="@language.Code">@language.DisplayName</option>
                }
            </select>
            <small>This language is sent to Azure Speech so transcripts match your preferred locale.</small>
        </div>

        <div class="settings-section">
            <label for="favoriteTagsInput">Favorite tags</label>
            <InputText id="favoriteTagsInput"
                       @bind-Value="_formModel.FavoriteTags"
                       placeholder="Comma separated tags (e.g. meetings, demos, bugs)" />
            <small>We'll reuse these tags when suggesting AI labels.</small>
        </div>

        <div class="settings-actions">
            <button type="submit" disabled="@_isSaving">Save preferences</button>
            <button type="button"
                    class="secondary"
                    disabled="@_isRefreshingDevices"
                    @onclick="() => RefreshDevices(true)">Refresh devices</button>
        </div>
    </EditForm>

    if (HasHttpsCertificate)
    {
        <div class="settings-section">
            <div class="settings-actions">
                <div>
                    <label>HTTPS certificate</label>
                    <small>Download the public PEM served by this host so other devices can trust it.</small>
                </div>
                <a class="icon-button"
                   href="api/settings/https/certificate.pem"
                   download="@CertificateFileName"
                   title="Download HTTPS certificate (.pem)"
                   aria-label="Download HTTPS certificate">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                        <path d="M5 20h14v-2H5v2zm7-18v10.17l3.59-3.58L17 11l-5 5-5-5 1.41-1.41L11 12.17V2h2z" />
                    </svg>
                </a>
            </div>
        </div>
    }

    if (!_deviceAccessGranted)
    {
        <p class="settings-warning">
            We couldn't enumerate your media devices. Please grant the browser permission to use your camera and microphone,
            then refresh the device list.
        </p>
    }

    if (!string.IsNullOrWhiteSpace(_statusMessage))
    {
        <p>@_statusMessage</p>
    }
}

@code
{
    private record MediaDeviceInfo(string DeviceId, string Kind, string Label);
    private record LanguageOption(string Code, string DisplayName);
    private sealed class PreferencesModel
    {
        public string? CameraDeviceId { get; set; }
        public string? MicrophoneDeviceId { get; set; }
        public string TranscriptLanguage { get; set; } = UserMediaPreferences.Default.TranscriptLanguage;
        public string FavoriteTags { get; set; } = string.Empty;
    }

    private static readonly LanguageOption[] LanguageOptions =
    [
        new("af-ZA", "Afrikaans (South Africa)"),
        new("am-ET", "Amharic (Ethiopia)"),
        new("ar-AE", "Arabic (United Arab Emirates)"),
        new("ar-BH", "Arabic (Bahrain)"),
        new("ar-DZ", "Arabic (Algeria)"),
        new("ar-EG", "Arabic (Egypt)"),
        new("ar-IQ", "Arabic (Iraq)"),
        new("ar-JO", "Arabic (Jordan)"),
        new("ar-KW", "Arabic (Kuwait)"),
        new("ar-LB", "Arabic (Lebanon)"),
        new("ar-LY", "Arabic (Libya)"),
        new("ar-MA", "Arabic (Morocco)"),
        new("ar-OM", "Arabic (Oman)"),
        new("ar-QA", "Arabic (Qatar)"),
        new("ar-SA", "Arabic (Saudi Arabia)"),
        new("ar-SY", "Arabic (Syria)"),
        new("ar-TN", "Arabic (Tunisia)"),
        new("ar-YE", "Arabic (Yemen)"),
        new("az-AZ", "Azerbaijani (Azerbaijan)"),
        new("bg-BG", "Bulgarian (Bulgaria)"),
        new("bn-BD", "Bangla (Bangladesh)"),
        new("bn-IN", "Bangla (India)"),
        new("bs-BA", "Bosnian (Bosnia and Herzegovina)"),
        new("ca-ES", "Catalan (Spain)"),
        new("cs-CZ", "Czech (Czechia)"),
        new("cy-GB", "Welsh (United Kingdom)"),
        new("da-DK", "Danish (Denmark)"),
        new("de-AT", "German (Austria)"),
        new("de-CH", "German (Switzerland)"),
        new("de-DE", "German (Germany)"),
        new("el-GR", "Greek (Greece)"),
        new("en-AU", "English (Australia)"),
        new("en-CA", "English (Canada)"),
        new("en-GB", "English (United Kingdom)"),
        new("en-HK", "English (Hong Kong)"),
        new("en-IE", "English (Ireland)"),
        new("en-IN", "English (India)"),
        new("en-KE", "English (Kenya)"),
        new("en-NG", "English (Nigeria)"),
        new("en-NZ", "English (New Zealand)"),
        new("en-PH", "English (Philippines)"),
        new("en-SG", "English (Singapore)"),
        new("en-TZ", "English (Tanzania)"),
        new("en-US", "English (United States)"),
        new("en-ZA", "English (South Africa)"),
        new("es-AR", "Spanish (Argentina)"),
        new("es-BO", "Spanish (Bolivia)"),
        new("es-CL", "Spanish (Chile)"),
        new("es-CO", "Spanish (Colombia)"),
        new("es-CR", "Spanish (Costa Rica)"),
        new("es-CU", "Spanish (Cuba)"),
        new("es-DO", "Spanish (Dominican Republic)"),
        new("es-EC", "Spanish (Ecuador)"),
        new("es-ES", "Spanish (Spain)"),
        new("es-GT", "Spanish (Guatemala)"),
        new("es-HN", "Spanish (Honduras)"),
        new("es-MX", "Spanish (Mexico)"),
        new("es-NI", "Spanish (Nicaragua)"),
        new("es-PA", "Spanish (Panama)"),
        new("es-PE", "Spanish (Peru)"),
        new("es-PR", "Spanish (Puerto Rico)"),
        new("es-PY", "Spanish (Paraguay)"),
        new("es-SV", "Spanish (El Salvador)"),
        new("es-US", "Spanish (United States)"),
        new("es-UY", "Spanish (Uruguay)"),
        new("es-VE", "Spanish (Venezuela)"),
        new("et-EE", "Estonian (Estonia)"),
        new("eu-ES", "Basque (Spain)"),
        new("fa-IR", "Persian (Iran)"),
        new("fi-FI", "Finnish (Finland)"),
        new("fil-PH", "Filipino (Philippines)"),
        new("fr-BE", "French (Belgium)"),
        new("fr-CA", "French (Canada)"),
        new("fr-CH", "French (Switzerland)"),
        new("fr-FR", "French (France)"),
        new("ga-IE", "Irish (Ireland)"),
        new("gl-ES", "Galician (Spain)"),
        new("gu-IN", "Gujarati (India)"),
        new("he-IL", "Hebrew (Israel)"),
        new("hi-IN", "Hindi (India)"),
        new("hr-HR", "Croatian (Croatia)"),
        new("hu-HU", "Hungarian (Hungary)"),
        new("hy-AM", "Armenian (Armenia)"),
        new("id-ID", "Indonesian (Indonesia)"),
        new("is-IS", "Icelandic (Iceland)"),
        new("it-IT", "Italian (Italy)"),
        new("ja-JP", "Japanese (Japan)"),
        new("jv-ID", "Javanese (Indonesia)"),
        new("ka-GE", "Georgian (Georgia)"),
        new("kk-KZ", "Kazakh (Kazakhstan)"),
        new("km-KH", "Khmer (Cambodia)"),
        new("kn-IN", "Kannada (India)"),
        new("ko-KR", "Korean (South Korea)"),
        new("lo-LA", "Lao (Laos)"),
        new("lt-LT", "Lithuanian (Lithuania)"),
        new("lv-LV", "Latvian (Latvia)"),
        new("mk-MK", "Macedonian (North Macedonia)"),
        new("ml-IN", "Malayalam (India)"),
        new("mn-MN", "Mongolian (Mongolia)"),
        new("mr-IN", "Marathi (India)"),
        new("ms-MY", "Malay (Malaysia)"),
        new("mt-MT", "Maltese (Malta)"),
        new("my-MM", "Myanmar (Myanmar)"),
        new("nb-NO", "Norwegian Bokmål (Norway)"),
        new("ne-NP", "Nepali (Nepal)"),
        new("nl-BE", "Dutch (Belgium)"),
        new("nl-NL", "Dutch (Netherlands)"),
        new("pl-PL", "Polish (Poland)"),
        new("ps-AF", "Pashto (Afghanistan)"),
        new("pt-BR", "Portuguese (Brazil)"),
        new("pt-PT", "Portuguese (Portugal)"),
        new("ro-RO", "Romanian (Romania)"),
        new("ru-RU", "Russian (Russia)"),
        new("si-LK", "Sinhala (Sri Lanka)"),
        new("sk-SK", "Slovak (Slovakia)"),
        new("sl-SI", "Slovenian (Slovenia)"),
        new("sq-AL", "Albanian (Albania)"),
        new("sr-RS", "Serbian (Serbia)"),
        new("su-ID", "Sundanese (Indonesia)"),
        new("sv-SE", "Swedish (Sweden)"),
        new("sw-KE", "Swahili (Kenya)"),
        new("sw-TZ", "Swahili (Tanzania)"),
        new("ta-IN", "Tamil (India)"),
        new("ta-LK", "Tamil (Sri Lanka)"),
        new("ta-MY", "Tamil (Malaysia)"),
        new("ta-SG", "Tamil (Singapore)"),
        new("te-IN", "Telugu (India)"),
        new("th-TH", "Thai (Thailand)"),
        new("tr-TR", "Turkish (Türkiye)"),
        new("uk-UA", "Ukrainian (Ukraine)"),
        new("ur-IN", "Urdu (India)"),
        new("ur-PK", "Urdu (Pakistan)"),
        new("uz-UZ", "Uzbek (Uzbekistan)"),
        new("vi-VN", "Vietnamese (Vietnam)"),
        new("zh-CN", "Chinese (Mainland)"),
        new("zh-HK", "Chinese (Hong Kong)"),
        new("zh-TW", "Chinese (Taiwan)"),
        new("zu-ZA", "Zulu (South Africa)")
    ];

    private IJSObjectReference? _mediaDevicesModule;
    private readonly PreferencesModel _formModel = new();
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isRefreshingDevices;
    private bool _deviceAccessGranted = true;
    private bool _requestPermissionsOnFirstRender;
    private bool _preferencesLoaded;
    private string? _statusMessage;
    private List<MediaDeviceInfo> _cameras = new();
    private List<MediaDeviceInfo> _microphones = new();
    private HttpsCertificateInfo _httpsCertificateInfo = new(false, null);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadPreferencesAsync();
        }
        catch (Exception ex)
        {
            _statusMessage = $"Failed to load preferences: {ex.Message}";
        }

        try
        {
            await LoadHttpsCertificateInfoAsync();
        }
        catch (Exception ex)
        {
            _statusMessage ??= $"Failed to load HTTPS certificate info: {ex.Message}";
        }

        _isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _preferencesLoaded)
        {
            await RefreshDevices(_requestPermissionsOnFirstRender);
            if (!_deviceAccessGranted)
            {
                await RefreshDevices(true);
            }
        }
    }

    private async Task LoadPreferencesAsync()
    {
        // Load device preferences from cookie
        var devicePrefs = await DevicePreferencesService.GetDevicePreferencesAsync();
        _formModel.CameraDeviceId = NormalizeForInput(devicePrefs.CameraDeviceId);
        _formModel.MicrophoneDeviceId = NormalizeForInput(devicePrefs.MicrophoneDeviceId);

        // Load language and tags from server
        var serverPrefs = await MediaSettingsClient.GetMediaPreferencesAsync();
        _formModel.TranscriptLanguage = NormalizeLanguageForInput(serverPrefs.TranscriptLanguage);
        _formModel.FavoriteTags = string.Join(", ", serverPrefs.FavoriteTags ?? Array.Empty<string>());

        _requestPermissionsOnFirstRender = IsUnconfigured(devicePrefs, serverPrefs);
        _preferencesLoaded = true;
    }

    private async Task LoadHttpsCertificateInfoAsync()
    {
        _httpsCertificateInfo = await ServerSettingsClient.GetHttpsCertificateInfoAsync();
    }

    private bool HasHttpsCertificate => _httpsCertificateInfo.IsConfigured;

    private string CertificateFileName
        => string.IsNullOrWhiteSpace(_httpsCertificateInfo.SuggestedFileName)
            ? "https-certificate.pem"
            : _httpsCertificateInfo.SuggestedFileName;

    private async Task RefreshDevices(bool requestPermissions = false)
    {
        _isRefreshingDevices = true;
        _statusMessage = null;
        try
        {
            _mediaDevicesModule ??= await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/mediaDevices.js");
            var devices = await _mediaDevicesModule.InvokeAsync<MediaDeviceInfo[]>("listDevices", requestPermissions);
            _cameras = devices.Where(d => d.Kind == "videoinput").ToList();
            _microphones = devices.Where(d => d.Kind == "audioinput").ToList();
            _deviceAccessGranted = devices.Any();
        }
        catch (JSException jsEx)
        {
            _deviceAccessGranted = false;
            _statusMessage = $"Unable to read devices: {jsEx.Message}";
        }
        finally
        {
            _isRefreshingDevices = false;
            StateHasChanged();
        }
    }

    private async Task SavePreferences()
    {
        _isSaving = true;
        _statusMessage = null;
        try
        {
            // Save device preferences to cookie
            var devicePrefs = new DevicePreferences(
                NormalizeSelection(_formModel.CameraDeviceId),
                NormalizeSelection(_formModel.MicrophoneDeviceId));
            await DevicePreferencesService.SaveDevicePreferencesAsync(devicePrefs);

            // Save language and tags to server (without device IDs)
            var serverPrefs = new UserMediaPreferences(
                null,
                null,
                NormalizeLanguageSelection(_formModel.TranscriptLanguage),
                ParseFavoriteTags(_formModel.FavoriteTags));
            await MediaSettingsClient.SaveMediaPreferencesAsync(serverPrefs);

            _statusMessage = "Preferences saved. Future recordings will use the selected devices.";
        }
        catch (Exception ex)
        {
            _statusMessage = $"Failed to save preferences: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_mediaDevicesModule is not null)
        {
            await _mediaDevicesModule.DisposeAsync();
        }
    }

    private static string NormalizeForInput(string? value)
        => string.IsNullOrWhiteSpace(value) || value == "default" ? string.Empty : value;

    private static string? NormalizeSelection(string? value)
        => string.IsNullOrWhiteSpace(value) || value == "default" ? null : value;

    private static string NormalizeLanguageForInput(string? code)
        => string.IsNullOrWhiteSpace(code) ? UserMediaPreferences.Default.TranscriptLanguage : code;

    private static string NormalizeLanguageSelection(string? code)
    {
        if (string.IsNullOrWhiteSpace(code))
        {
            return UserMediaPreferences.Default.TranscriptLanguage;
        }

        var normalized = code.Trim();
        return LanguageOptions.Any(option => string.Equals(option.Code, normalized, StringComparison.OrdinalIgnoreCase))
            ? normalized
            : UserMediaPreferences.Default.TranscriptLanguage;
    }

    private static bool IsUnconfigured(DevicePreferences devicePrefs, UserMediaPreferences serverPrefs)
    {
        var hasCamera = !string.IsNullOrWhiteSpace(devicePrefs.CameraDeviceId);
        var hasMicrophone = !string.IsNullOrWhiteSpace(devicePrefs.MicrophoneDeviceId);
        var hasFavoriteTags = serverPrefs.FavoriteTags is { Count: > 0 };
        var language = NormalizeLanguageForInput(serverPrefs.TranscriptLanguage);
        var hasCustomLanguage = !string.Equals(
            language,
            UserMediaPreferences.Default.TranscriptLanguage,
            StringComparison.OrdinalIgnoreCase);

        return !hasCamera && !hasMicrophone && !hasFavoriteTags && !hasCustomLanguage;
    }

    private static IReadOnlyCollection<string> ParseFavoriteTags(string? value)
        => string.IsNullOrWhiteSpace(value)
            ? Array.Empty<string>()
            : value.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToArray();
}
