@page "/settings"
@implements IAsyncDisposable
@inject IMediaSettingsClient MediaSettingsClient
@inject IDevicePreferencesService DevicePreferencesService
@inject IServerSettingsClient ServerSettingsClient
@inject IJSRuntime JsRuntime
@inject ToastService ToastService
@using System
@using System.Collections.Generic
@using System.Linq
@using System.Text
@using DiaryApp.Shared.Abstractions
@using Microsoft.JSInterop

<div class="page-header">
    <a href="/" class="back-to-record-button" title="Back to recording" aria-label="Back to recording">
        <svg viewBox="0 0 32 24" class="back-to-record-icon" aria-hidden="true">
            <!-- Arrow pointing left -->
            <path d="M10 7l-5 5 5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <!-- REC circle -->
            <circle cx="22" cy="12" r="5" fill="#ff4444"/>
        </svg>
    </a>
    <h1>Recording Settings</h1>
</div>

@if (_isLoading)
{
    <p>Loading your device preferences...</p>
}
else
{
    if (!_deviceAccessGranted)
    {
        <div class="settings-warning">
            <p>We couldn't access your media devices. This may be because:</p>
            <ul>
                <li>Browser permissions haven't been granted yet</li>
                <li>No camera or microphone is connected</li>
                <li>Another application is using the devices</li>
            </ul>
            <button type="button" @onclick="RequestPermissions" disabled="@_isRequestingPermissions">
                @if (_isRequestingPermissions)
                {
                    <span class="button-spinner" aria-hidden="true"></span>
                    <span>Requesting access...</span>
                }
                else
                {
                    <span>Grant Camera & Microphone Access</span>
                }
            </button>
        </div>
    }

    <EditForm Model="_formModel" OnValidSubmit="SavePreferences">
        <div class="settings-section">
            <label for="cameraSelect">Preferred webcam</label>
            <select id="cameraSelect" 
                    class="@((IsCameraNotConfigured || ShouldHighlightDeviceSelection) ? "field-warning" : "")"
                    @bind="_formModel.CameraDeviceId"
                    @onfocus="OnDeviceSelectFocus"
                    @onclick="OnDeviceSelectFocus"
                    @onpointerdown="OnDeviceSelectFocus">
                @if (_cameras.Count == 0)
                {
                    <option value="" disabled>@GetDevicePlaceholderText(_savedCameraLabel)</option>
                }
                else
                {
                    <option value="">Choose Device</option>
                    @foreach (var camera in _cameras)
                    {
                        <option value="@camera.DeviceId">@camera.Label</option>
                    }
                }
            </select>
            @if (IsCameraNotConfigured)
            {
                <small class="field-warning-text">Please select a specific webcam for consistent recording quality.</small>
            }
            else
            {
                <small>Stored on this device only (browser local storage).</small>
            }
        </div>

        <div class="settings-section">
            <label for="microphoneSelect">Preferred microphone</label>
            <select id="microphoneSelect"
                    class="@((IsMicrophoneNotConfigured || ShouldHighlightDeviceSelection) ? "field-warning" : "")"
                    @bind="_formModel.MicrophoneDeviceId"
                    @onfocus="OnDeviceSelectFocus"
                    @onclick="OnDeviceSelectFocus"
                    @onpointerdown="OnDeviceSelectFocus">
                @if (_microphones.Count == 0)
                {
                    <option value="" disabled>@GetDevicePlaceholderText(_savedMicrophoneLabel)</option>
                }
                else
                {
                    <option value="">Choose Device</option>
                    @foreach (var microphone in _microphones)
                    {
                        <option value="@microphone.DeviceId">@microphone.Label</option>
                    }
                }
            </select>
            @if (IsMicrophoneNotConfigured)
            {
                <small class="field-warning-text">Please select a specific microphone for consistent audio quality.</small>
            }
            else
            {
                <small>Stored on this device only (browser local storage).</small>
            }
        </div>

        <div class="settings-section">
            <label for="languageSelect">Transcript language</label>
            <select id="languageSelect" @bind="_formModel.TranscriptLanguage">
                @foreach (var language in LanguageOptions)
                {
                    <option value="@language.Code">@language.DisplayName</option>
                }
            </select>
            <small>This language is sent to Azure Speech so transcripts match your preferred locale.</small>
        </div>

        <div class="settings-section">
            <label for="favoriteTagsInput">Favorite tags</label>
            <InputText id="favoriteTagsInput"
                       @bind-Value="_formModel.FavoriteTags"
                       placeholder="Comma separated tags (e.g. meetings, demos, bugs)" />
            <small>We'll reuse these tags when suggesting AI labels.</small>
        </div>

        <div class="settings-actions">
            <button type="submit" disabled="@(_isSaving || !CanSavePreferences)">Save preferences</button>
        </div>
    </EditForm>

    if (HasHttpsCertificate)
    {
        <div class="settings-section">
            <div class="settings-actions">
                <div>
                    <label>HTTPS certificate</label>
                    <small>Download the public PEM served by this host so other devices can trust it.</small>
                </div>
                <a class="icon-button"
                   href="api/settings/https/certificate.pem"
                   download="@CertificateFileName"
                   title="Download HTTPS certificate (.pem)"
                   aria-label="Download HTTPS certificate">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                        <path d="M5 20h14v-2H5v2zm7-18v10.17l3.59-3.58L17 11l-5 5-5-5 1.41-1.41L11 12.17V2h2z" />
                    </svg>
                </a>
            </div>
        </div>
    }
}

@code
{
    private const string DevicePlaceholderText = "Choose Device";
    private record MediaDeviceInfo(string DeviceId, string Kind, string Label);
    private record LanguageOption(string Code, string DisplayName);
    private sealed class PreferencesModel
    {
        public string? CameraDeviceId { get; set; }
        public string? MicrophoneDeviceId { get; set; }
        public string TranscriptLanguage { get; set; } = "en-US";
        public string FavoriteTags { get; set; } = string.Empty;
    }

    private static readonly LanguageOption[] LanguageOptions =
    [
        new("af-ZA", "Afrikaans (South Africa)"),
        new("am-ET", "Amharic (Ethiopia)"),
        new("ar-AE", "Arabic (United Arab Emirates)"),
        new("ar-BH", "Arabic (Bahrain)"),
        new("ar-DZ", "Arabic (Algeria)"),
        new("ar-EG", "Arabic (Egypt)"),
        new("ar-IQ", "Arabic (Iraq)"),
        new("ar-JO", "Arabic (Jordan)"),
        new("ar-KW", "Arabic (Kuwait)"),
        new("ar-LB", "Arabic (Lebanon)"),
        new("ar-LY", "Arabic (Libya)"),
        new("ar-MA", "Arabic (Morocco)"),
        new("ar-OM", "Arabic (Oman)"),
        new("ar-QA", "Arabic (Qatar)"),
        new("ar-SA", "Arabic (Saudi Arabia)"),
        new("ar-SY", "Arabic (Syria)"),
        new("ar-TN", "Arabic (Tunisia)"),
        new("ar-YE", "Arabic (Yemen)"),
        new("az-AZ", "Azerbaijani (Azerbaijan)"),
        new("bg-BG", "Bulgarian (Bulgaria)"),
        new("bn-BD", "Bangla (Bangladesh)"),
        new("bn-IN", "Bangla (India)"),
        new("bs-BA", "Bosnian (Bosnia and Herzegovina)"),
        new("ca-ES", "Catalan (Spain)"),
        new("cs-CZ", "Czech (Czechia)"),
        new("cy-GB", "Welsh (United Kingdom)"),
        new("da-DK", "Danish (Denmark)"),
        new("de-AT", "German (Austria)"),
        new("de-CH", "German (Switzerland)"),
        new("de-DE", "German (Germany)"),
        new("el-GR", "Greek (Greece)"),
        new("en-AU", "English (Australia)"),
        new("en-CA", "English (Canada)"),
        new("en-GB", "English (United Kingdom)"),
        new("en-HK", "English (Hong Kong)"),
        new("en-IE", "English (Ireland)"),
        new("en-IN", "English (India)"),
        new("en-KE", "English (Kenya)"),
        new("en-NG", "English (Nigeria)"),
        new("en-NZ", "English (New Zealand)"),
        new("en-PH", "English (Philippines)"),
        new("en-SG", "English (Singapore)"),
        new("en-TZ", "English (Tanzania)"),
        new("en-US", "English (United States)"),
        new("en-ZA", "English (South Africa)"),
        new("es-AR", "Spanish (Argentina)"),
        new("es-BO", "Spanish (Bolivia)"),
        new("es-CL", "Spanish (Chile)"),
        new("es-CO", "Spanish (Colombia)"),
        new("es-CR", "Spanish (Costa Rica)"),
        new("es-CU", "Spanish (Cuba)"),
        new("es-DO", "Spanish (Dominican Republic)"),
        new("es-EC", "Spanish (Ecuador)"),
        new("es-ES", "Spanish (Spain)"),
        new("es-GT", "Spanish (Guatemala)"),
        new("es-HN", "Spanish (Honduras)"),
        new("es-MX", "Spanish (Mexico)"),
        new("es-NI", "Spanish (Nicaragua)"),
        new("es-PA", "Spanish (Panama)"),
        new("es-PE", "Spanish (Peru)"),
        new("es-PR", "Spanish (Puerto Rico)"),
        new("es-PY", "Spanish (Paraguay)"),
        new("es-SV", "Spanish (El Salvador)"),
        new("es-US", "Spanish (United States)"),
        new("es-UY", "Spanish (Uruguay)"),
        new("es-VE", "Spanish (Venezuela)"),
        new("et-EE", "Estonian (Estonia)"),
        new("eu-ES", "Basque (Spain)"),
        new("fa-IR", "Persian (Iran)"),
        new("fi-FI", "Finnish (Finland)"),
        new("fil-PH", "Filipino (Philippines)"),
        new("fr-BE", "French (Belgium)"),
        new("fr-CA", "French (Canada)"),
        new("fr-CH", "French (Switzerland)"),
        new("fr-FR", "French (France)"),
        new("ga-IE", "Irish (Ireland)"),
        new("gl-ES", "Galician (Spain)"),
        new("gu-IN", "Gujarati (India)"),
        new("he-IL", "Hebrew (Israel)"),
        new("hi-IN", "Hindi (India)"),
        new("hr-HR", "Croatian (Croatia)"),
        new("hu-HU", "Hungarian (Hungary)"),
        new("hy-AM", "Armenian (Armenia)"),
        new("id-ID", "Indonesian (Indonesia)"),
        new("is-IS", "Icelandic (Iceland)"),
        new("it-IT", "Italian (Italy)"),
        new("ja-JP", "Japanese (Japan)"),
        new("jv-ID", "Javanese (Indonesia)"),
        new("ka-GE", "Georgian (Georgia)"),
        new("kk-KZ", "Kazakh (Kazakhstan)"),
        new("km-KH", "Khmer (Cambodia)"),
        new("kn-IN", "Kannada (India)"),
        new("ko-KR", "Korean (South Korea)"),
        new("lo-LA", "Lao (Laos)"),
        new("lt-LT", "Lithuanian (Lithuania)"),
        new("lv-LV", "Latvian (Latvia)"),
        new("mk-MK", "Macedonian (North Macedonia)"),
        new("ml-IN", "Malayalam (India)"),
        new("mn-MN", "Mongolian (Mongolia)"),
        new("mr-IN", "Marathi (India)"),
        new("ms-MY", "Malay (Malaysia)"),
        new("mt-MT", "Maltese (Malta)"),
        new("my-MM", "Myanmar (Myanmar)"),
        new("nb-NO", "Norwegian Bokmål (Norway)"),
        new("ne-NP", "Nepali (Nepal)"),
        new("nl-BE", "Dutch (Belgium)"),
        new("nl-NL", "Dutch (Netherlands)"),
        new("pl-PL", "Polish (Poland)"),
        new("ps-AF", "Pashto (Afghanistan)"),
        new("pt-BR", "Portuguese (Brazil)"),
        new("pt-PT", "Portuguese (Portugal)"),
        new("ro-RO", "Romanian (Romania)"),
        new("ru-RU", "Russian (Russia)"),
        new("si-LK", "Sinhala (Sri Lanka)"),
        new("sk-SK", "Slovak (Slovakia)"),
        new("sl-SI", "Slovenian (Slovenia)"),
        new("sq-AL", "Albanian (Albania)"),
        new("sr-RS", "Serbian (Serbia)"),
        new("su-ID", "Sundanese (Indonesia)"),
        new("sv-SE", "Swedish (Sweden)"),
        new("sw-KE", "Swahili (Kenya)"),
        new("sw-TZ", "Swahili (Tanzania)"),
        new("ta-IN", "Tamil (India)"),
        new("ta-LK", "Tamil (Sri Lanka)"),
        new("ta-MY", "Tamil (Malaysia)"),
        new("ta-SG", "Tamil (Singapore)"),
        new("te-IN", "Telugu (India)"),
        new("th-TH", "Thai (Thailand)"),
        new("tr-TR", "Turkish (Türkiye)"),
        new("uk-UA", "Ukrainian (Ukraine)"),
        new("ur-IN", "Urdu (India)"),
        new("ur-PK", "Urdu (Pakistan)"),
        new("uz-UZ", "Uzbek (Uzbekistan)"),
        new("vi-VN", "Vietnamese (Vietnam)"),
        new("zh-CN", "Chinese (Mainland)"),
        new("zh-HK", "Chinese (Hong Kong)"),
        new("zh-TW", "Chinese (Taiwan)"),
        new("zu-ZA", "Zulu (South Africa)")
    ];

    private IJSObjectReference? _mediaDevicesModule;
    private readonly PreferencesModel _formModel = new();
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isRequestingPermissions;
    private bool _permissionsRequested;
    private bool _deviceAccessGranted = true;
    private int _permissionFailureCount;
    private string? _savedCameraLabel;
    private string? _savedMicrophoneLabel;
    private List<MediaDeviceInfo> _cameras = new();
    private List<MediaDeviceInfo> _microphones = new();
    private HttpsCertificateInfo _httpsCertificateInfo = new(false, null);

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // First, try to enumerate devices without requesting permissions
                // This will work if permissions were already granted
                await RefreshDevices(requestPermissions: false);

                // Then load preferences
                await LoadPreferencesAsync();

                // If we got devices with labels, permissions are already granted
                // If not, we'll show the "Grant access" button (needed for Safari)
                // Don't auto-request permissions - Safari requires explicit user gesture
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to initialize settings: {ex.Message}");
            }
            finally
            {
                try
                {
                    await LoadHttpsCertificateInfoAsync();
                }
                catch (Exception ex)
                {
                    ToastService.ShowError($"Failed to load HTTPS certificate info: {ex.Message}");
                }

                _isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadPreferencesAsync()
    {
        // Load device preferences from cookie
        var devicePrefs = await DevicePreferencesService.GetDevicePreferencesAsync();
        _formModel.CameraDeviceId = NormalizeForInput(devicePrefs.CameraDeviceId);
        _formModel.MicrophoneDeviceId = NormalizeForInput(devicePrefs.MicrophoneDeviceId);
        _savedCameraLabel = devicePrefs.CameraLabel;
        _savedMicrophoneLabel = devicePrefs.MicrophoneLabel;
        UpdateCachedDeviceLabels();

        // Load language and tags from server
        var serverPrefs = await MediaSettingsClient.GetMediaPreferencesAsync();
        _formModel.TranscriptLanguage = await GetEffectiveLanguageAsync(serverPrefs.TranscriptLanguage);
        _formModel.FavoriteTags = string.Join(", ", serverPrefs.FavoriteTags ?? Array.Empty<string>());
    }

    private async Task<string> GetEffectiveLanguageAsync(string? serverLanguage)
    {
        // If the server has an explicitly saved language, use it
        if (!string.IsNullOrWhiteSpace(serverLanguage))
        {
            return serverLanguage;
        }

        // Otherwise, try to get the browser's language
        try
        {
            _mediaDevicesModule ??= await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/mediaDevices.js");
            var browserLanguage = await _mediaDevicesModule.InvokeAsync<string?>("getBrowserLanguage");
            
            if (!string.IsNullOrWhiteSpace(browserLanguage))
            {
                // Check if the browser language is in our supported list
                var match = LanguageOptions.FirstOrDefault(opt =>
                    string.Equals(opt.Code, browserLanguage, StringComparison.OrdinalIgnoreCase));
                if (match is not null)
                {
                    return match.Code;
                }

                // Try matching just the language part (e.g., "it" from "it-IT")
                var languagePart = browserLanguage.Split('-')[0];
                var partialMatch = LanguageOptions.FirstOrDefault(opt =>
                    opt.Code.StartsWith(languagePart + "-", StringComparison.OrdinalIgnoreCase));
                if (partialMatch is not null)
                {
                    return partialMatch.Code;
                }
            }
        }
        catch(Exception ex)
        {
            // If JS interop fails, fall back to default
        }

        // Fall back to English (US) if nothing else works
        return "en-US";
    }

    private async Task LoadHttpsCertificateInfoAsync()
    {
        _httpsCertificateInfo = await ServerSettingsClient.GetHttpsCertificateInfoAsync();
    }

    private bool HasHttpsCertificate => _httpsCertificateInfo.IsConfigured;

    private bool IsCameraNotConfigured => string.IsNullOrWhiteSpace(_formModel.CameraDeviceId) && _cameras.Count > 0;
    
    private bool IsMicrophoneNotConfigured => string.IsNullOrWhiteSpace(_formModel.MicrophoneDeviceId) && _microphones.Count > 0;

    private bool CanSavePreferences =>
        !string.IsNullOrWhiteSpace(_formModel.CameraDeviceId) &&
        !string.IsNullOrWhiteSpace(_formModel.MicrophoneDeviceId);

    private bool ShouldHighlightDeviceSelection => !_deviceAccessGranted;

    private string CertificateFileName
        => string.IsNullOrWhiteSpace(_httpsCertificateInfo.SuggestedFileName)
            ? "https-certificate.pem"
            : _httpsCertificateInfo.SuggestedFileName;

    private async Task RefreshDevices(bool requestPermissions = false)
    {
        try
        {
            _mediaDevicesModule ??= await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/mediaDevices.js");
            var devices = await _mediaDevicesModule.InvokeAsync<MediaDeviceInfo[]>("listDevices", requestPermissions);
            var labeledDevices = devices.Where(d => !string.IsNullOrWhiteSpace(d.Label)).ToList();
            _cameras = labeledDevices.Where(d => d.Kind == "videoinput").ToList();
            _microphones = labeledDevices.Where(d => d.Kind == "audioinput").ToList();
            _deviceAccessGranted = labeledDevices.Any();
            UpdateCachedDeviceLabels();
        }
        catch (JSException jsEx)
        {
            _deviceAccessGranted = false;
            ToastService.ShowWarning($"Unable to read devices: {jsEx.Message}");
        }
    }

    private async Task OnDeviceSelectFocus()
    {
        // If we already have devices with proper access, no need to request permissions
        if (_deviceAccessGranted && (_cameras.Count > 0 || _microphones.Count > 0))
        {
            return;
        }

        // If we've already tried requesting permissions once, don't spam
        if (_permissionsRequested)
        {
            return;
        }

        // Mark as requested so we don't trigger multiple times
        _permissionsRequested = true;
        
        // Request permissions - this is triggered by user gesture (focus/click on dropdown)
        await RequestPermissionsInternal(showToast: false);
    }

    private async Task RequestPermissions()
    {
        await RequestPermissionsInternal(showToast: true);
    }

    private async Task RequestPermissionsInternal(bool showToast)
    {
        _isRequestingPermissions = true;
        StateHasChanged();
        
        try
        {
            _mediaDevicesModule ??= await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/mediaDevices.js");
            var result = await _mediaDevicesModule.InvokeAsync<PermissionResult>("requestMediaPermissions");
            
            if (result.Success)
            {
                _permissionFailureCount = 0;
                // Permissions granted, refresh device list
                await RefreshDevices(requestPermissions: false);
                
                if (showToast)
                {
                    if (result.AudioOnly)
                    {
                        ToastService.ShowWarning("Microphone access granted. Camera access was denied or no camera is available.");
                    }
                    else
                    {
                        ToastService.ShowSuccess("Camera and microphone access granted!");
                    }
                }
                
                StateHasChanged();
            }
            else
            {
                _permissionsRequested = false;
                _permissionFailureCount++;
                if (showToast)
                {
                    ToastService.ShowError(ComposePermissionErrorMessage(result.Error));
                }
            }
        }
        catch (Exception ex)
        {
            _permissionsRequested = false;
            _permissionFailureCount++;
            if (showToast)
            {
                ToastService.ShowError(ComposePermissionErrorMessage(ex.Message));
            }
        }
        finally
        {
            _isRequestingPermissions = false;
            StateHasChanged();
        }
    }

    private async Task SavePreferences()
    {
        if (!CanSavePreferences)
        {
            ToastService.ShowWarning("Choose a specific camera and microphone before saving.");
            return;
        }

        _isSaving = true;
        var deviceSaveSuccess = false;
        var serverSaveSuccess = false;
        
        try
        {
            var selectedCameraId = NormalizeSelection(_formModel.CameraDeviceId);
            var selectedMicrophoneId = NormalizeSelection(_formModel.MicrophoneDeviceId);
            var resolvedCameraLabel = ResolveDeviceLabel(selectedCameraId, _cameras, _savedCameraLabel);
            var resolvedMicrophoneLabel = ResolveDeviceLabel(selectedMicrophoneId, _microphones, _savedMicrophoneLabel);

            // Save device preferences to local storage (with cookie fallback)
            var devicePrefs = new DevicePreferences(
                selectedCameraId,
                selectedMicrophoneId,
                resolvedCameraLabel,
                resolvedMicrophoneLabel);
            deviceSaveSuccess = await DevicePreferencesService.SaveDevicePreferencesAsync(devicePrefs);

            if (deviceSaveSuccess)
            {
                _savedCameraLabel = resolvedCameraLabel;
                _savedMicrophoneLabel = resolvedMicrophoneLabel;
            }

            // Save language and tags to server (without device IDs)
            var serverPrefs = new UserMediaPreferences(
                null,
                null,
                NormalizeLanguageSelection(_formModel.TranscriptLanguage),
                ParseFavoriteTags(_formModel.FavoriteTags));
            await MediaSettingsClient.SaveMediaPreferencesAsync(serverPrefs);
            serverSaveSuccess = true;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save server preferences: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }

        // Show appropriate feedback based on what succeeded
        if (serverSaveSuccess && deviceSaveSuccess)
        {
            ToastService.ShowSuccess("Preferences saved. Future recordings will use the selected devices.");
        }
        else if (serverSaveSuccess && !deviceSaveSuccess)
        {
            ToastService.ShowWarning("Language and tags saved, but device preferences could not be stored locally. They may not persist across browser sessions.");
        }
        else if (!serverSaveSuccess && deviceSaveSuccess)
        {
            ToastService.ShowWarning("Device preferences saved locally, but server preferences could not be saved.");
        }
        // If both failed, the error was already shown in the catch block
    }

    public async ValueTask DisposeAsync()
    {
        if (_mediaDevicesModule is not null)
        {
            await _mediaDevicesModule.DisposeAsync();
        }
    }

    private static string NormalizeForInput(string? value)
        => string.IsNullOrWhiteSpace(value) ? string.Empty : value;

    private static string? NormalizeSelection(string? value)
        => string.IsNullOrWhiteSpace(value) ? null : value;

    private static string NormalizeLanguageForInput(string? code)
        => string.IsNullOrWhiteSpace(code) ? "en-US" : code;

    private static string NormalizeLanguageSelection(string? code)
    {
        if (string.IsNullOrWhiteSpace(code))
        {
            return "en-US";
        }

        var normalized = code.Trim();
        return LanguageOptions.Any(option => string.Equals(option.Code, normalized, StringComparison.OrdinalIgnoreCase))
            ? normalized
            : "en-US";
    }

    private static bool IsUnconfigured(DevicePreferences devicePrefs, UserMediaPreferences serverPrefs)
    {
        var hasCamera = !string.IsNullOrWhiteSpace(devicePrefs.CameraDeviceId);
        var hasMicrophone = !string.IsNullOrWhiteSpace(devicePrefs.MicrophoneDeviceId);
        var hasFavoriteTags = serverPrefs.FavoriteTags is { Count: > 0 };
        var hasCustomLanguage = !string.IsNullOrWhiteSpace(serverPrefs.TranscriptLanguage);

        return !hasCamera && !hasMicrophone && !hasFavoriteTags && !hasCustomLanguage;
    }

    private static string? ResolveDeviceLabel(string? selectedDeviceId, IReadOnlyCollection<MediaDeviceInfo> devices, string? fallbackLabel)
    {
        if (string.IsNullOrWhiteSpace(selectedDeviceId))
        {
            return null;
        }

        var match = devices.FirstOrDefault(device => string.Equals(device.DeviceId, selectedDeviceId, StringComparison.Ordinal));
        return match?.Label ?? fallbackLabel;
    }

    private void UpdateCachedDeviceLabels()
    {
        var normalizedCameraId = NormalizeSelection(_formModel.CameraDeviceId);
        if (!string.IsNullOrWhiteSpace(normalizedCameraId))
        {
            _savedCameraLabel = ResolveDeviceLabel(normalizedCameraId, _cameras, _savedCameraLabel);
        }

        var normalizedMicrophoneId = NormalizeSelection(_formModel.MicrophoneDeviceId);
        if (!string.IsNullOrWhiteSpace(normalizedMicrophoneId))
        {
            _savedMicrophoneLabel = ResolveDeviceLabel(normalizedMicrophoneId, _microphones, _savedMicrophoneLabel);
        }
    }

    private string GetDevicePlaceholderText(string? savedLabel)
        => string.IsNullOrWhiteSpace(savedLabel) ? DevicePlaceholderText : savedLabel;

    private static IReadOnlyCollection<string> ParseFavoriteTags(string? value)
        => string.IsNullOrWhiteSpace(value)
            ? Array.Empty<string>()
            : value.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToArray();

    private sealed class PermissionResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
        public bool AudioOnly { get; set; }
    }

    private string ComposePermissionErrorMessage(string? error)
    {
        var builder = new StringBuilder();
        builder.Append($"Permission denied: {error ?? "Unknown error"}. Please check your browser settings.");
        if (_permissionFailureCount >= 3)
        {
            builder.Append(" Also verify your operating system privacy settings allow the browser to access the camera and microphone.");
        }
        return builder.ToString();
    }
}
